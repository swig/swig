datarootdir = @datarootdir@
srcdir=@srcdir@
VPATH=@srcdir@

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
mandir=@mandir@
INSTALLCMD=@INSTALL@
PACKAGE_NAME=@PACKAGE_NAME@
PROGRAM_NAME=@PROGRAM_NAME@
# Soft link test can be skipped on systems that don't support soft linking
NOSOFTLINKSTEST=

CC=@CC@
CFLAGS_CCACHE=@CFLAGS_CCACHE@
CFLAGS=@CFLAGS@ -I. $(CFLAGS_CCACHE)
OBJEXT=@OBJEXT@
SWIG=swig
SWIG_LIB=../$(srcdir)/../Lib
EXEEXT=@EXEEXT@

LIBS_CCACHE=@LIBS_CCACHE@
LIBS=@LIBS@ $(LIBS_CCACHE)
OBJS = $(foreach n,args ccache cleanup execute hash mdfour snprintf stats unify util,$n.$(OBJEXT))
HEADERS = ccache.h mdfour.h config.h ccache_swig_config.h

all: $(PACKAGE_NAME)$(EXEEXT)

# Regenerate Makefile if Makefile.in or config.status have changed.
Makefile: $(srcdir)/Makefile.in ./config.status
	$(SHELL) ./config.status

# Note that HTML documentation is actually generated and used from the main SWIG documentation Makefile
docs: $(srcdir)/$(PACKAGE_NAME).1 $(srcdir)/web/$(PACKAGE_NAME)-man.html

$(OBJS): %.$(OBJEXT): %.c $(HEADERS)
	$(CC) $(CFLAGS) -c -o $@ $<
$(PACKAGE_NAME)$(EXEEXT): $(OBJS)
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $(OBJS) $(LIBS)

$(srcdir)/$(PACKAGE_NAME).1: $(srcdir)/ccache.yo
	-yodl2man -o $(srcdir)/$(PACKAGE_NAME).1 $(srcdir)/ccache.yo

$(srcdir)/web/$(PACKAGE_NAME)-man.html: $(srcdir)/ccache.yo
	yodl2html -o $(srcdir)/web/$(PACKAGE_NAME)-man.html $(srcdir)/ccache.yo

install: $(PACKAGE_NAME)$(EXEEXT)
	@echo "Installing $(PACKAGE_NAME)"
	@echo "Installing $(DESTDIR)${bindir}/$(PROGRAM_NAME)$(EXEEXT)"
	${INSTALLCMD} -d $(DESTDIR)${bindir}
	echo "${INSTALLCMD} -m 755 $(PACKAGE_NAME)$(EXEEXT) $(DESTDIR)${bindir}/$(PROGRAM_NAME)$(EXEEXT)"
	${INSTALLCMD} -m 755 $(PACKAGE_NAME)$(EXEEXT) $(DESTDIR)${bindir}/$(PROGRAM_NAME)$(EXEEXT)

install-docs: $(srcdir)/$(PACKAGE_NAME).1
	@echo "Installing $(DESTDIR)${mandir}/man1/$(PROGRAM_NAME).1"
	${INSTALLCMD} -d $(DESTDIR)${mandir}/man1
	${INSTALLCMD} -m 644 $(srcdir)/$(PACKAGE_NAME).1 $(DESTDIR)${mandir}/man1/$(PROGRAM_NAME).1

uninstall: $(PACKAGE_NAME)$(EXEEXT)
	rm -f $(DESTDIR)${bindir}/$(PROGRAM_NAME)$(EXEEXT)

uninstall-docs: $(srcdir)/$(PACKAGE_NAME).1
	rm -f $(DESTDIR)${mandir}/man1/$(PROGRAM_NAME).1

clean: clean-docs
	/bin/rm -f $(OBJS) *~ $(PACKAGE_NAME)$(EXEEXT)

clean-docs:
	rm -f $(srcdir)/$(PACKAGE_NAME).1 $(srcdir)/web/$(PACKAGE_NAME)-man.html

test: test.sh
	SWIG_LIB='$(SWIG_LIB)' PATH=../..:$$PATH SWIG='$(SWIG)' CC='$(CC)' NOSOFTLINKSTEST='$(NOSOFTLINKSTEST)' CCACHE='../$(PACKAGE_NAME)' CCACHE_PROG=$(PROGRAM_NAME) $(srcdir)/test.sh

check: test

distclean: clean
	/bin/rm -f Makefile config.h config.sub config.log build-stamp config.status ccache_swig_config.h
	/bin/rm -rf autom4te.cache

maintainer-clean: distclean
	/bin/rm -f $(srcdir)/$(PACKAGE_NAME).1 $(srcdir)/web/$(PACKAGE_NAME)-man.html


# FIXME: To fix this, test.sh needs to be able to take ccache from the
# installed prefix, not from the source dir.
installcheck:
	@echo "WARNING!  This is not really \"installcheck\" yet."
	$(MAKE) check
