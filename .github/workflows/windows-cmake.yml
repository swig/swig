name: windows-cmake

on:
  push:
    paths-ignore:
      - '.github/workflows/linux.yml'
      - '.github/workflows/macos.yml'
      - '.github/workflows/windows.yml'
      - 'CHANGES*'
      - 'Doc/**'
      - 'Tools/CI-linux-*'
      - 'Tools/GHA-linux-*'
  pull_request:
    branches: master
    paths-ignore:
      - '.github/workflows/linux.yml'
      - '.github/workflows/macos.yml'
      - '.github/workflows/windows.yml'
      - 'CHANGES*'
      - 'Doc/**'
      - 'Tools/CI-linux-*'
      - 'Tools/GHA-linux-*'

permissions:
  contents: read

jobs:
  cmake:
    runs-on: ${{ matrix.os }}

    name: CMake VS ${{ matrix.VER }}

    strategy:
      matrix:
        include:
        - VER: '17 2022'
          os: 'windows-2025'

    env:
      BUILD_SYS: Visual Studio ${{ matrix.VER }}

    steps:
    - name: Machine Info
      shell: powershell
      run: |
          systeminfo | findstr /B /C:"OS Name" /B /C:"OS Version"

    - name: Checkout
      uses: actions/checkout@v4
      with:
        show-progress: false

    - name: Install CCache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ matrix.os }}

    # The NuGet PCRE2 package is build with '/MT' to statically links the the UCRT library.
    # See explanation on linking option:
    # https://learn.microsoft.com/en-us/cpp/c-runtime-library/crt-library-features
    - name: Install NuGet Packages
      shell: powershell
      run: |
          nuget install PCRE2 -OutputDirectory C:\Tools
          nuget install Bison -OutputDirectory C:\Tools

    # https://cygwin.com/cygwin-ug-net/cygpath.html
    - name: Prepare Environment
      shell: bash
      run: |
          cat << EOF >> $GITHUB_ENV
          PCRE2_PATH=$(cygpath -w "$(ls -d /C/Tools/PCRE2*)")
          EOF
          BISON_PATH=$(cygpath -w "$(ls -d /C/Tools/Bison*)/bin")
          echo "$BISON_PATH" >> $GITHUB_PATH

    # Use CMAKE_MSVC_RUNTIME_LIBRARY to use static C runtimes,
    # since NuGet PCRE2 uses static liked non-debug C runtime.
    # Using /NODEFAULTLIB, require /NODEFAULTLIB:MSVCRT for the release configuration,
    # and /NODEFAULTLIB:MSVCRTD for the debug configuration
    - name: Configure
      shell: powershell
      run: |
          cmake --version
          cmake -S . -B . -G "$env:BUILD_SYS" -A x64 `
          -DCMAKE_INSTALL_PREFIX="C:\Tools\swig" `
          -DCMAKE_C_FLAGS="/W3 /EHsc" `
          -DCMAKE_CXX_FLAGS="/W3 /EHsc" `
          -DCMAKE_MSVC_RUNTIME_LIBRARY="MultiThreaded$<$<CONFIG:Debug>:Debug>" `
          -DPCRE2_ROOT="$env:PCRE2_PATH" `
          -DPCRE2_USE_STATIC_LIBS=ON

    - name: Build
      shell: powershell
      run: |
          cmake --build . --config Release

    - name: Test
      shell: powershell
      run: |
          ctest --output-on-failure -V -C Release

    - name: Install
      shell: powershell
      run: |
          cmake --install .
          C:\Tools\swig\bin\swig.exe -version
